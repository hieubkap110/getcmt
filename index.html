<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Display and Edit JSON Array</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    />
    <!-- Font Awesome CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-cp+0P8D/yfCsP5v5kfpZVKf60N8SSWSDT9RbN/OoU/7G5J3cqFPbK1C8v+ZPpeRgFZ8PzOWB7Do1PQsS67gpxIw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- SweetAlert2 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      pre {
        white-space: pre-wrap;
      }

      .delete-button,
      .edit-button {
        margin-right: 10px;
        cursor: pointer;
      }

      #shuffleButton {
        cursor: pointer;
      }

      .comment-list {
        display: none;
      }

      .table-container {
        display: block;
      }

      .comment-list-container {
        display: none;
      }
      #commentListView li {
        list-style: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <input
        type="email"
        id="input-data"
        class="form-control"
        placeholder="Nhập Danh Sách Comment"
      />
      <div class="d-flex align-items-center mt-3 justify-content-center">
        <button onclick="addJsonData()" class="btn btn-success mx-2">
          Thêm Danh Sách Comment
        </button>
        <button
          id="shuffleButton"
          onclick="shuffleArray()"
          class="btn btn-primary"
        >
          Trộn
        </button>
        <button
          id="toggleViewButton"
          onclick="toggleView()"
          class="btn btn-secondary mx-2"
        >
          Chuyển đổi Xem
        </button>
      </div>
    </div>

    <hr />
    <b>
      <p id="totalComments"></p>
    </b>

    <!-- Bootstrap Table -->
    <div class="container-fluid mt-4 table-container">
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th scope="col">Comment</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody id="commentsList"></tbody>
      </table>
    </div>

    <!-- Comment List -->
    <div class="container-fluid mt-4 comment-list-container">
      <h5>Danh Sách Comment:</h5>
      <pre id="commentListView"></pre>
    </div>

    <!-- Edit Modal -->
    <div
      class="modal"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Chỉnh sửa Comment</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <textarea
              class="form-control"
              id="editedComment"
              rows="3"
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveEditedComment()"
            >
              Lưu thay đổi
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      var jsonArray = [];
      let editedIndex = -1;
      let viewMode = "table";

      function addJsonData() {
        var inputData = document.getElementById("input-data").value;

        try {
          var parsedData = JSON.parse(inputData);
          parsedData = parsedData.data.ratings;

          if (Array.isArray(parsedData)) {
            jsonArray = jsonArray.concat(parsedData);
          } else {
            jsonArray.push(parsedData);
          }

          displayComments(jsonArray);

          document.getElementById("input-data").value = "";
        } catch (error) {
          alert("Chưa thêm dữ liệu");
        }
      }

      const commentsListDiv = document.getElementById("commentsList");
      const totalCommentsParagraph = document.getElementById("totalComments");
      const commentListView = document.getElementById("commentListView");
      const tableContainer = document.querySelector(".table-container");
      const commentListContainer = document.querySelector(
        ".comment-list-container"
      );

      function cleanComment(comment) {
        let cleanedComment = comment
          .replace(/Đúng với mô tả:[^\n]*\n/g, "")
          .replace(/Chất lượng sản phẩm:[^\n]*\n\n/g, "")
          .replace(/Công dụng:[^\n]*\n/g, "")
          .replace(/Đối tượng sử dụng:[^\n]*\n/g, "")
          .replace(/Mùi hương:[^\n]*\n/g, "")
          .replace(/Phù hợp với loại da:[^\n]*\n/g, "")
          .replace(/Chất liệu:[^\n]*\n/g, "")
          .replace(/Độ bền:[^\n]*\n/g, "")
          .replace(/Kiểu dáng:[^\n]*\n/g, "")
          .replace(/^\s*[\r\n]/gm, "");
        return cleanedComment.trim();
      }

      function shuffleArray() {
        for (let i = jsonArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [jsonArray[i], jsonArray[j]] = [jsonArray[j], jsonArray[i]];
        }
        displayComments(jsonArray);
      }

      function displayComments(commentsArray) {
        commentsListDiv.innerHTML = "";
        commentListView.innerHTML = "";

        let uniqueComments = commentsArray.reduce((acc, current, index) => {
          const cleanedComment = cleanComment(current.comment);
          if (
            cleanedComment &&
            !acc.find(
              (comment) => cleanComment(comment.comment) === cleanedComment
            )
          ) {
            acc.push({ ...current, comment: cleanedComment });
          }
          return acc;
        }, []);

        uniqueComments.forEach((commentObj, index) => {
          if (commentObj.comment) {
            if (viewMode === "table") {
              const commentContainer = document.createElement("tr");

              const commentColumn = document.createElement("td");
              commentColumn.textContent = commentObj.comment;

              const actionColumn = document.createElement("td");
              actionColumn.classList.add("d-flex", "align-items-center");

              // Edit button
              const editButton = document.createElement("button");
              editButton.classList.add("btn", "btn-primary", "edit-button");
              editButton.innerHTML = "Sửa";
              editButton.onclick = () => openEditModal(index);

              // Delete button
              const deleteButton = document.createElement("button");
              deleteButton.classList.add("btn", "btn-danger", "delete-button");
              deleteButton.innerHTML = "Xoá";
              deleteButton.onclick = () => deleteComment(index);

              actionColumn.appendChild(editButton);
              actionColumn.appendChild(deleteButton);

              commentContainer.appendChild(commentColumn);
              commentContainer.appendChild(actionColumn);

              commentsListDiv.appendChild(commentContainer);
            } else if (viewMode === "list") {
              const commentListItem = document.createElement("li");
              commentListItem.textContent = commentObj.comment;

              commentListView.appendChild(commentListItem);
            }
          }
        });

        totalCommentsParagraph.textContent = `Tổng số comment: ${uniqueComments.length}`;
        toggleViewElements();
      }

      function toggleViewElements() {
        if (viewMode === "table") {
          tableContainer.style.display = "block";
          commentListContainer.style.display = "none";
        } else if (viewMode === "list") {
          tableContainer.style.display = "none";
          commentListContainer.style.display = "block";
        }
      }

      function deleteComment(index) {
        jsonArray.splice(index, 1);
        displayComments(jsonArray);
      }

      function openEditModal(index) {
        editedIndex = index;
        const editedCommentText = jsonArray[index].comment;
        document.getElementById("editedComment").value =
          cleanComment(editedCommentText);
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      function saveEditedComment() {
        if (editedIndex !== -1) {
          const editedComment = document.getElementById("editedComment").value;
          jsonArray[editedIndex].comment = editedComment;
          displayComments(jsonArray);
          // Đóng modal
          document
            .getElementById("editModal")
            .querySelector("[data-bs-dismiss='modal']")
            .click();
        }
      }

      function toggleView() {
        viewMode = viewMode === "table" ? "list" : "table";
        displayComments(jsonArray);
      }

      // Initial display of comments
      displayComments(jsonArray);
    </script>
  </body>
</html>
